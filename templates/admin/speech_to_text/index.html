{% extends "admin/layout.html" %}
{% block title %}دستیار صوتی{% endblock %}
{% block page_title %}دستیار صوتی{% endblock %}

{% block css %}
<style>
    .status-indicator {
        transition: all 0.3s ease;
    }

    .transcript-container {
        max-height: 400px;
        overflow-y: auto;
    }

    .message-item {
        padding: 8px 12px;
        border-radius: 6px;
        margin-bottom: 8px;
    }

    .message-user {
        background-color: #e3f2fd;
        border-left: 3px solid #2196f3;
    }

    .message-ai {
        background-color: #e8f5e9;
        border-left: 3px solid #4caf50;
    }

    .message-error {
        background-color: #ffebee;
        border-left: 3px solid #f44336;
    }

    .message-info {
        background-color: #f3e5f5;
        border-left: 3px solid #9c27b0;
    }

    .control-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .audio-visualizer {
        height: 60px;
        background-color: #f5f5f5;
        border-radius: 4px;
        margin: 10px 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-12 mx-auto">
        <div class="card shadow-sm rounded-4 p-4">
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <h4>دستیار صوتی</h4>
                    <div class="control-buttons">
                        <button id="connectBtn" class="btn btn-sm btn-primary">
                            <i class="fas fa-plug me-1"></i> اتصال
                        </button>
                        <button id="disconnectBtn" class="btn btn-sm btn-danger" disabled>
                            <i class="fas fa-unlink me-1"></i> قطع اتصال
                        </button>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div class="control-buttons">
                        <button id="startRecordBtn" class="btn btn-sm btn-success" disabled>
                            <i class="fas fa-microphone me-1"></i> شروع ضبط
                        </button>
                        <button id="stopRecordBtn" class="btn btn-sm btn-warning" disabled>
                            <i class="fas fa-stop me-1"></i> توقف ضبط
                        </button>
                        <button id="clearBtn" class="btn btn-sm btn-secondary">
                            <i class="fas fa-trash me-1"></i> پاک سازی
                        </button>
                    </div>
                    <div>
                        <span id="statusIndicator" class="badge status-indicator badge-secondary">اتصال قطع شد</span>
                    </div>
                </div>
            </div>

            <div class="audio-visualizer" id="audioVisualizer">
                <div class="text-muted">نمایش صدا اینجا خواهد بود</div>
            </div>

            <div class="mb-3">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">نمایش گفتگوها</h5>
                        <span class="badge bg-info" id="messageCount">۰ پیام</span>
                    </div>
                    <div class="card-body">
                        <div id="transcriptContainer" class="transcript-container border rounded p-3">
                            <p class="text-muted">گفتگوها اینجا ظاهر می‌شوند…</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast notifications container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-info-circle me-2 text-primary"></i>
            <strong class="me-auto" id="toastTitle">اطلاعیه</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            محتوای پیام
        </div>
    </div>
</div>

<input type="hidden" id="token" value="{{token}}">
{% endblock %}

{% block js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const assistant_id = {{ assistant_id }};
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const startRecordBtn = document.getElementById('startRecordBtn');
        const stopRecordBtn = document.getElementById('stopRecordBtn');
        const clearBtn = document.getElementById('clearBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const transcriptContainer = document.getElementById('transcriptContainer');
        const messageCount = document.getElementById('messageCount');
        const audioVisualizer = document.getElementById('audioVisualizer');
        const notificationToast = document.getElementById('notificationToast');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');

        let websocket = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let stream = null;
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let animationId = null;
        let messageCounter = 0;

        const toast = new bootstrap.Toast(notificationToast);

        // Connect WebSocket
        connectBtn.addEventListener('click', async function () {
            try {
                const token = $("#token").val();
                if (!token) { showToast('Authentication Error', 'No authentication token found.', 'danger'); return; }

                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/admin/ws/speech-to-text?token=${token}`;

                updateUIState('connecting');

                websocket = new WebSocket(wsUrl);

                websocket.onopen = function () {
                    updateUIState('connected');
                    addMessage('متصل به سرویس تبدیل گفتار به متن', 'info');
                    showToast('اتصال موفق', 'ارتباط وب سوکت برقرار شد', 'success');
                };

                websocket.onmessage = function (event) {
                    if (event.data instanceof Blob) return;

                    try { handleWebSocketMessage(JSON.parse(event.data)); }
                    catch (e) { console.error('Error parsing WS message:', e); addMessage(`Error: ${e.message}`, 'error'); }
                };

                websocket.onclose = function (event) {
                    updateUIState('disconnected');
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
                    if (event.code !== 1000) showToast('Connection Closed', event.reason || 'Unknown', 'warning');
                };

                websocket.onerror = function (error) {
                    console.error('WebSocket error:', error);
                    addMessage(`خطای WebSocket: ${error.message || 'ناشناخته'}`, 'error');
                    showToast('خطای اتصال', 'اتصال ناموفق بود', 'danger');
                    updateUIState('error');
                };

            } catch (error) {
                console.error('Connection error:', error);
                addMessage(`خطای اتصال: ${error.message}`, 'error');
                showToast('خطای اتصال', error.message, 'danger');
                updateUIState('error');
            }
        });

        // Disconnect WebSocket
        disconnectBtn.addEventListener('click', () => { if (websocket) websocket.close(1000, 'User disconnected'); });

        // Start recording
        startRecordBtn.addEventListener('click', async function () {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true, channelCount: 1 } });
                setupAudioVisualization(stream);

                const options = getSupportedMimeType();
                audioChunks = [];
                mediaRecorder = new MediaRecorder(stream, options);

                mediaRecorder.ondataavailable = function (event) { if (event.data.size > 0) audioChunks.push(event.data); }

                mediaRecorder.onstop = async function () {
                    const blob = new Blob(audioChunks, { type: options.mimeType || "audio/webm" });
                    const arrayBuffer = await blob.arrayBuffer();
                    if (websocket && websocket.readyState === WebSocket.OPEN) {
                        websocket.send(arrayBuffer);
                        websocket.send(JSON.stringify({ type: 'audio_end' }));
                    }
                    stopAudioVisualization();
                    audioChunks = [];
                };

                mediaRecorder.start();
                updateUIState('recording');
                addMessage('شروع ضبط', 'info');

            } catch (error) {
                console.error('Recording error:', error);
                addMessage(`خطای ضبط: ${error.message}`, 'error');
                showToast('خطای ضبط', error.message, 'danger');
            }
        });

        // Stop recording
        stopRecordBtn.addEventListener('click', function () {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            if (stream) stream.getTracks().forEach(track => track.stop());
            updateUIState('connected');
            addMessage('ضبط متوقف شد', 'info');
        });

        // Clear transcript
        clearBtn.addEventListener('click', function () {
            transcriptContainer.innerHTML = '<p class="text-muted">Transcripts will appear here...</p>';
            messageCounter = 0;
            updateMessageCount();
        });

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'connection': addMessage(`Connection status: ${data.status}`, 'info'); break;
                case 'transcript':
                    addMessage(`شما گفتید : ${data.text}`, 'user');
                    sendAssistant(data.text)
                    break;
                case 'text': addMessage(`AI: ${data.text}`, 'ai'); break;
                case 'status': if (data.status === 'listening') { updateUIState('listening'); } else if (data.status === 'processing') { updateUIState('processing'); } break;
                case 'error': addMessage(`Error: ${data.error}`, 'error'); showToast('Error', data.error, 'danger'); break;
                case 'session_ready': addMessage('Speech-to-text session ready', 'success'); showToast('Session Ready', 'The speech-to-text session is ready', 'success'); break;
            }
        }

        function updateUIState(state) {
            switch (state) {
                case 'disconnected': connectBtn.disabled = false; disconnectBtn.disabled = true; startRecordBtn.disabled = true; stopRecordBtn.disabled = true; updateStatus('اتصال قطع شد', 'secondary'); break;
                case 'connecting': connectBtn.disabled = true; disconnectBtn.disabled = false; startRecordBtn.disabled = true; stopRecordBtn.disabled = true; updateStatus('در حال اتصال…', 'info'); break;
                case 'connected': connectBtn.disabled = true; disconnectBtn.disabled = false; startRecordBtn.disabled = false; stopRecordBtn.disabled = true; updateStatus('متصل شد', 'success'); break;
                case 'recording': startRecordBtn.disabled = true; stopRecordBtn.disabled = false; updateStatus('در حال ضبط ...', 'warning'); break;
                case 'listening': updateStatus('در حال گوش دادن ...', 'info'); break;
                case 'processing': updateStatus('در حال پردازش ...', 'warning'); break;
                case 'error': connectBtn.disabled = false; disconnectBtn.disabled = true; startRecordBtn.disabled = true; stopRecordBtn.disabled = true; updateStatus('Error', 'danger'); break;
            }
        }

        function updateStatus(status, type) { statusIndicator.textContent = status; statusIndicator.className = `badge status-indicator badge-${type}`; }
        function addMessage(message, type) { messageCounter++; updateMessageCount(); const timestamp = new Date().toLocaleTimeString(); const cls = type === 'user' ? 'message-user' : type === 'ai' ? 'message-ai' : type === 'error' ? 'message-error' : 'message-info'; const placeholder = transcriptContainer.querySelector('.text-muted'); if (placeholder) placeholder.remove(); const el = document.createElement('div'); el.className = `message-item ${cls}`; el.innerHTML = `<div class="d-flex justify-content-between"><span>${message}</span><small class="text-muted">${timestamp}</small></div>`; transcriptContainer.appendChild(el); transcriptContainer.scrollTop = transcriptContainer.scrollHeight; }
        function updateMessageCount() { messageCount.textContent = `${messageCounter} پیام${messageCounter !== 1 ? '' : ''}`; }
        function showToast(title, message, type = 'info') { toastTitle.textContent = title; toastMessage.textContent = message; const toastHeader = notificationToast.querySelector('.toast-header'); const icon = toastHeader.querySelector('i'); icon.className = 'fas me-2'; switch (type) { case 'success': icon.classList.add('fa-check-circle', 'text-success'); break; case 'danger': icon.classList.add('fa-exclamation-circle', 'text-danger'); break; case 'warning': icon.classList.add('fa-exclamation-triangle', 'text-warning'); break; default: icon.classList.add('fa-info-circle', 'text-primary'); } toast.show(); }

        function setupAudioVisualization(stream) {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                analyser.fftSize = 256;
                microphone.connect(analyser);
                visualizeAudio();
            } catch (e) { console.error('Error setting up audio visualization:', e); }
        }

        function visualizeAudio() {
            if (!analyser) return;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            const canvas = document.createElement('canvas');
            canvas.width = audioVisualizer.clientWidth; canvas.height = audioVisualizer.clientHeight;
            audioVisualizer.innerHTML = ''; audioVisualizer.appendChild(canvas);
            const ctx = canvas.getContext('2d');
            function draw() { animationId = requestAnimationFrame(draw); analyser.getByteFrequencyData(dataArray); ctx.fillStyle = 'rgb(245,245,245)'; ctx.fillRect(0, 0, canvas.width, canvas.height); let barWidth = (canvas.width / bufferLength) * 2.5; let barHeight; let x = 0; for (let i = 0; i < bufferLength; i++) { barHeight = dataArray[i] / 2; ctx.fillStyle = `rgb(${Math.min(255, barHeight + 100)},50,50)`; ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight); x += barWidth + 1; } }
            draw();
        }

        function stopAudioVisualization() {
            if (animationId) { cancelAnimationFrame(animationId); animationId = null; }
            if (microphone) { microphone.disconnect(); microphone = null; }
            if (audioContext) { audioContext.close(); audioContext = null; }
            audioVisualizer.innerHTML = '<div class="text-muted">نمایش صدا اینجا خواهد بود</div>';
        }

        function getSupportedMimeType() {
            const types = ['audio/webm;codecs=opus', 'audio/webm', 'audio/ogg;codecs=opus', 'audio/ogg', 'audio/wav', 'audio/mp4'];
            for (const t of types) { if (MediaRecorder.isTypeSupported(t)) return { mimeType: t }; }
            return {};
        }

        updateUIState('disconnected');

        async function sendAssistant(question) {
            const formData = new FormData();
            formData.append('question', question);

            try {
                const response = await fetch(`/assistants/${assistant_id}/ask_audio`, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    alert('خطا در دریافت پاسخ. لطفاً بعداً تلاش کنید.');
                    return;
                }

                // const data = await response.json();

                // if (data.error) {
                //     alert('سیستم هنوز آماده نیست، لطفا کمی صبر کنید.');
                //     return;
                // }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);

                const audio = new Audio(url);
                audio.play();

            } catch (error) {
                alert('خطا در ارتباط با سرور.');
                console.error(error);
            } finally {
            }
        }
    });
</script>
{% endblock %}