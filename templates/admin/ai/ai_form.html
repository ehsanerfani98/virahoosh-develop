<div class="row">
  <div class="col-lg-12">
    <div class="d-flex align-items-center mb-3 gap-2">
      <div class="ai-icon">{{ ai_model.icon | safe }}</div>
      <h3 class="">{{ ai_model.title }}</h3>
    </div>
    <div class="alert alert-info" role="alert" style="line-height: 2">
      {{ ai_model.description }}
    </div>

    <form id="ai-form" data-model-id="{{ ai_model.id }}" method="post" class="card p-4 shadow-sm rounded-4 mb-4">
      <div class="mb-3">
        <label class="form-label">توضیحات تصویر</label>
        <textarea name="image_title" id="image_title" class="form-control" rows="3"></textarea>
      </div>

      {% for input in ai_model.inputs %}
      <fieldset>
        <legend>{{ input.title }}</legend>
        {% if input.input_type in ['text', 'number'] %}
        <input type="{{ input.input_type }}" name="{{ input.name }}" class="form-control" required />
        {% elif input.input_type == 'textarea' %}
        <textarea name="{{ input.name }}" class="form-control" rows="3" required></textarea>
        {% elif input.input_type == 'select' %}
        <select name="{{ input.name }}" class="form-select" required>
          {% for option in (input.options | default('[]') | loads) %}
          <option value="{{ option }}">{{ option }}</option>
          {% endfor %}
        </select>
        {% endif %}
      </fieldset>
      {% endfor %}

      <button type="submit" class="btn btn-primary px-4">تولید متن و تصویر</button>
    </form>

    <!-- نمایش نتیجه -->
    <div id="ai-response-box" style="display: none">
      <div class="card shadow-sm rounded-4 p-4 bg-light">
        <h5 class="mb-3">متن تولید شده:</h5>
        <div id="ai-response-html"
             style="max-height: 300px; overflow-y: auto; border:1px solid #ddd; padding:15px; border-radius:8px; background:white;"></div>

        <h5 class="mt-4 mb-3">تصویر تولید شده:</h5>
        <div class="text-center">
          <a href="" id="image-lightbox-link" data-lightbox="generated-image">
            <img id="generated-image" src="" alt="تصویر تولید شده"
                 class="img-fluid rounded" style="max-height: 300px;">
          </a>
          <br>
          <a href="#" target="_blank" id="download-btn" class="btn btn-sm btn-outline-primary mt-2">
            <i class="fas fa-download"></i> دانلود تصویر
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
$(document).ready(function () {
  const ai_id = $("#ai-form").data("model-id");
  const $form = $("#ai-form");
  const $submitBtn = $form.find('button[type="submit"]');
  const $loading = $('<span id="loading-spinner" style="display:none;"></span>');
  $submitBtn.after($loading);

  $form.on("submit", function (e) {
    e.preventDefault();
    $submitBtn.prop("disabled", true);
    $loading.show();

    const formData = $form.serialize();
    $.ajax({
      url: `/admin/ais/${ai_id}/generate-text-image`,
      type: "POST",
      data: formData,
      beforeSend: function () {
        $("#ai-response-box").hide();
      },
      success: function (res) {
        $("#ai-response-html").html(marked.parse(res.text_response));
        $("#generated-image").attr("src", res.image_url);
        $("#image-lightbox-link").attr("href", res.image_url);
        $("#download-btn").attr("href", res.image_url).attr("download", "image-" + Date.now() + ".jpg");
        $("#ai-response-box").fadeIn();
      },
      error: function (xhr) {
        let msg = "خطا در پردازش";
        try { msg = JSON.parse(xhr.responseText).message || msg; } catch (_) {}
        Swal.fire({ icon: 'error', title: 'خطا', text: msg });
      },
      complete: function () {
        $submitBtn.prop("disabled", false);
        $loading.hide();
      }
    });
  });
});
</script>
